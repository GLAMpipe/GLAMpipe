<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>GLAMpipe</title>

<script type="text/javascript" src="js/jquery-2.1.1.min.js"></script>
<script type="text/javascript" src="js/knockout.js"></script>
<script type="text/javascript" src="/js/jquery-ui.min.js"></script>
<script type="text/javascript" src="/js/funcs.js"></script>

<link rel="stylesheet" type="text/css" href="/css/metapipe.css" />
<link rel="stylesheet" type="text/css" href="/css/jquery-ui.css" />
<style>
	
</style>
<script>

	function compare(a,b) {
		if (a.title < b.title)
			return -1;
		if (a.title > b.title)
			return 1;
		return 0;
	}

	var BetterListModel = function () {
		var self = this;
		this.itemToAdd = ko.observable("");
		this.allItems = ko.observableArray(); // Initial items
		this.loadItems = function () {
			$.getJSON("/get/project/titles", function(data) { 
				data.sort(compare);
				self.allItems([]);
				for(var i = 0; i< data.length; i++) {
					self.allItems.push(data[i]);
				}
				
			})
		}
		
	 
		this.addItem = function () {
			var match = ko.utils.arrayFirst(self.allItems(), function(item) {
				return self.itemToAdd() === item.title;
			});
			
			if ((this.itemToAdd() != ""))  {// Prevent blanks 
				if(match) {
					alert("Project title \"" + self.itemToAdd() + "\" exists!");
				} else {
					var data = {'title':self.itemToAdd()};
					$.post("/create/project", data, function(returnedData) {
						self.itemToAdd(""); // Clear the text box 
						self.allItems([]);
						self.loadItems();
					});
				}
			}
		};
	 
		this.removeSelected = function () {
			this.allItems.removeAll(this.selectedItems());
			this.selectedItems([]); // Clear selection
		};
	 
		this.sortItems = function() {
			this.allItems.sort();
		};
		
		this.delete = function () {
			
		};
	};

	function onLoad()
	{
		
		$( "#dialog-confirm" ).hide();
		
		var projects = new BetterListModel();
		ko.applyBindings(projects);
		projects.loadItems();

		// check if server is ok. If not, then show error setup
		$.getJSON("/status", function(data) { 
			console.log(data);
			if(data.status != "ok")
				$('#iframe_view').attr('src', "/setup");
		})

		$("#show_project_creator").on("click", function() {
			$("#new_project").show();
		});


		// DELETE PROJECT
		// hmm, not using data-bind...
		$(document).on('click', ".delete_icon", function(e) {
			$( "#dialog-confirm" ).dialog({
			  resizable: false,
			  height:160,
			  modal: true,
			  buttons: {
				"Delete project": function() {
					$( this ).dialog( "close" );
					var docid = $(e.target).attr("docid");
					var data = {};
					$.post("/delete/project/" + docid, data, function(returnedData) {
						if(returnedData.error)
							alert("Could not remove project!" + returnedData.error);
						else
							projects.loadItems();
						
					});
				},
				Cancel: function() {
				  $( this ).dialog( "close" );
				}
			  }
			});
		})


	}
		
	
</script>
</head>
<body onload="onLoad();">

	<div>
	<input id="username" name="username"/><button id="login">login</button>
	
	</div>

<script>
	$("#login").click(function() {
		var data = {"username":"testi","password":"testi"};
            $.post("/login", data, function(returnedData) {
                console.log('created node');

            });
	});
</script>

	<!-- PROJECT HEADER -->
	<div id="project_header">
		<h2 class="inline_header">Projects</h2>
		 <button id="show_project_creator" class="right" >add project</button>
		 
	</div>

	<a href="/setup" target="_blank" class="button" >setup</a>

	<!-- PROJECTS -->
	<div class="collection_pipe">
		<div class="projects">
			<div id="new_project" class="hidden node source">
				<h2>Create project</h2>
				<form data-bind="submit:addItem">
					<input type="text" data-bind='value:itemToAdd, valueUpdate: "afterkeydown"' />
					<button type="submit" data-bind="enable: itemToAdd().length > 0">Add</button>
				</form>
			</div>
		
			<ul data-bind="foreach: allItems">
				<li>
					<a href="#" data-bind="text: title, attr: {href: 'project/' + _id}"></a><span data-bind="attr:{docid:_id}" class="right delete_icon">X</span>
				</li>
			</ul>
		</div>
	</div>
	
	<!-- VIEW TABS -->
	<div id="collection_view">
		<div class="IframeWrapper">
			<iframe id="iframe_view" class="iframetab" src="http://artturimatias.github.io/GLAMpipe/"></iframe>
		</div>
	</div>

	<div id="dialog-confirm" title="Really delete project?">
	  <p><span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>Removing project removes data from database. Are you sure?</p>
	</div>

	</body>
</html>
