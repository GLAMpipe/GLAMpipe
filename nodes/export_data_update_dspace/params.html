
<label>Choose DSpace REST API url or write url below.</label>
<select id="export-data-dspace-update_url" name="url">
	<option value="" selected disabled>predefined servers</option>
	<option value="http://demo.dspace.org/rest">http://demo.dspace.org/rest</option>
</select>
<button id="export-data-dspace-update_plus">+</button>

<!-- add options starts -->
<div id="export-data-dspace-update_addoption" style="display:none">
	<input id="export-data-dspace-update_url_add" placeholder="https://demo.dspace.org/rest/" name="url_add" />
	<button id="export-data-dspace-update_test" title="test DSpace rest api">test</button>
	<button id="export-data-dspace-update_add" title="add url to predefined urls">add</button>
</div>
<!-- add options ends -->


<div id="export-data-dspace-update_status" class="status"></div>

<div id="export-data-dspace_hidden" style="display:none">
	<select id="export-data-dspace-update_field_sel" name="original_field">
		<option value="" selected disabled>Choose</option>
	</select>

	<label>write response here</label>
	<input type="text" name="out_field" value="update_response"/>
</div>




<script>

// *************** CODE FOR ADDING NEW URLS starts **************
var add_div = $("#export-data-dspace-update_addoption");
var add_button = $("#export-data-dspace-update_add");
var add_input = $("#export-data-dspace-update_url_add");
var test_button = $("#export-data-dspace-update_test");
var plus_button = $("#export-data-dspace-update_plus");
var add_url_input = $("#export-data-dspace-update_url_add");


function testUrl (url, success, fail) {

	var status = $.getJSON("/proxy?url=" + url + "/status");
	
	status.done(function(data) {
		if(data.error) 
			fail("Server did not answer");
		else
			if(data.okay)
				success(data);
			else
				fail("Rest API error")
	});
	
	status.fail(function() {
		fail("Proxy not working");
	});
}


function addUrl (url) {
	var data = {}
	data.url = add_input.val();
	var post = $.post(url, data, function(response) {
		add_div.hide();
		add_input.val("");
		fetchParams();
		
	})	
}


test_button.click(function (e) {
	var url = add_url_input.val();
	if(url == "") {
		alert("Set the rest api url of DSpace");
		return;
	}
	
	function success () {dspace_status.text("Status: okay").removeClass().addClass("good");}
	function fail (msg) {dspace_status.text("Not okay! Check url ("+msg+")").removeClass().addClass("bad")}
	testUrl(url, success, fail);
})	

add_button.click(function () {
	//var url = "http://localhost:3000/node/export_data_dspace_update/params/add";
	var url = "http://localhost:3000/node/params/add/export_data_dspace_update";
	function success() {addUrl(url)};
	function fail(msg) {alert("DSpace rest url seems to invalid, can not add!")};
	testUrl(add_url_input.val(), success, fail);
	

})	

plus_button.click(function () {
	add_div.show();
})	
// *************** CODE FOR ADDING NEW URLS ends **************



var url_select = $("#export-data-dspace-update_url");
var field_select = $("#export-data-dspace-update_field_sel");
var field_div = $("#export-data-dspace_hidden");
var dspace_status = $("#export-data-dspace-update_status");

fetchParams();


// GET USER ADDED PARAMS
function fetchParams () {
	$.getJSON("http://localhost:3000/node/params/export_data_dspace_update", function (data) {
		if(data.error)
			alert(data.error);
		else {
			if(data && Array.isArray(data)) {
				dspace_status.empty();
				url_select.empty();
				url_select.append("<option value='' selected disabled>predefined servers</option>");
				url_select.append("<option value='http://demo.dspace.org/rest'>http://demo.dspace.org/rest</option>");
				data[0].url.forEach(function(url_opt) {
					url_select.append($("<option></option>").text(url_opt).attr("value", url_opt));
				})
			}
		}
	})
}


function compareOptions() {
	url_select.forEach(function(opt) {
		console.log(opt);
	})
}

// GET FIELD LIST
function fetchFields (url) {

	dspace_status.empty().removeClass().append("<h4>Fetching field info ... </h4>");
	
	$.getJSON("/proxy?url=" + url + "/registries/schema", function (data) {
		if(data.error)
			alert(data.error);
		else {
			var html = "";
			data.forEach(function(schema) {
				schema.metadataFields.forEach(function(field) {
					html += "<option value='"+field.name+"'>" + field.name + "</option>"; 
				})
			}) 

			field_select.empty();
			field_select.append(html);
			field_div.show();
			dspace_status.empty().removeClass().append("Fields fetched! Choose field below.").addClass("good");
		}
	})
}
	


// CHOOSE SERVER HANDLER
$("#export-data-dspace-update_url").change(function() {
	var url = $("#export-data-dspace-update_url :selected").text();
	field_div.hide();
	field_select.empty();
	fetchFields(url);
});

</script>
