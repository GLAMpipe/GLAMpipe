{
	"nodeid": "transform_wikimedia_wikitext_template",
	"title": "Create wikitext",
	"type": "transform",
	"subtype": "wikimedia",
	"description": "Produce wikitext output based on template",
	"scripts": {
		"hello": "out.say('news', 'You added a wikitext node'); ",
		
        "bye": "out.say('news', 'Deleted wikitext node. Bye!'); ",
        
        "init":
        [
			"out.say('progress', 'Starting converting to wikitext...'); ",
			"/* set output field */",
			"out.field = context.node.params.out_field; "
		],
		
		"run": 
		[
			"var c = context; ",
			"var templates = ['Photograph', 'Map']; ",
			"var output = '{{' + templates[parseInt(c.node.params.template)] + '\\n'; ",
			"var settings = context.node.settings; ",
            "var wikifield = ''; ",
            
			"for (key in settings) {",
			"    if (key.indexOf('_wt_') === 0) { ",      
            "       if (key.indexOf('_wt_1') === 0 || key.indexOf('_wt_3') === 0 || key.indexOf('_wt_5') === 0 || key.indexOf('_wt_7') === 0 ) { ",
			"           wikifield += settings[key]; ",
            "       } else {",
			"           wikifield += c.get(context.doc, settings[key]); ",
            "       }",
            
            "/* set output on last field of series */",
            "       if (key.indexOf('_wt_7') === 0 ) { ",
			"           var stripped = key.replace(/_wt_7_/,''); ",
			"           output += '|' + stripped + ' = ' + wikifield + '\\n'; ",
            "           wikifield = ''; ",
            "       } ",
			"    }",
			"}",
	
			"output += '}}\\n'; ",
			
			"var cats = c.get(context.doc, settings.categories); ",
			"if (cats.constructor.name === 'Array') {",
			"    for(var i = 0; i < cats.length; i++) {",
			"        output += '[[Category:' + cats[i] + ']]\\n'; ",
			"    }",
			"}",
			
			"if(settings.category_all != '') ",
			"    output += '[[Category:' + settings.category_all + ']]\\n'; ",
			
			"output += '[[Category:metapipe uploads]]\\n'; ",
			"out.value = output; "
		],
		
		"finish": "out.say('finish', 'wikitext conversion done!');"

	},
	
	"views": {
		"data_static": 
		[
			"<button data-bind=\"click: prevPage\">prev</button>",
			"<button data-bind=\"click: nextPage\">next</button>",
			"<div id=\"node_bar\" class=\"selected\">",
			"    <h2 class=\"selected\">wikitext</h2>",
			"</div>",
			"<div>",
			"    <table>",
			"        <thead>",
			"            <tr>",
			"                <th id=\"vcc\" data-bind=\"click: sort\">[count]</th>",
			"                <th id=\"id\" data-bind=\"click: sort\">id</th>",
			"                <th id=\"wikitext\" >wikitext</th>",
			"            </tr>",
			"        </thead>",
			"        <tbody data-bind=\"foreach: collection\">",
			"            <tr>",
			"                <td data-bind=\"text: vcc\"></td>",
			"                <td data-bind=\"text: id\"></td>",
			"                <td data-bind=\"html: wikitext.replace(/\\|/g,'<br>')\"></td>",
			"            </tr> ",
			"        </tbody> ",
			"    </table>",
			"</div>"
		],

		"params":
		[
			"<label>choose template</label>",
			"<select id='template' name='template'>",
			"    <option value='0'>Photograph</option>",
			"    <option value='1'>Map</option>",
			"</select>",
			"<label>output field</label>",
			"<input value='wikitext' name='out_field' />"
		],
		
		"settings":
		[
			"<div>You can test your wikitext by copying it <a target='_blank' href='https://commons.wikimedia.org/wiki/Special:ExpandTemplates?uselang=en'>here</a>.</div>",
			"<div id='node_set___node_id__' class='template_map'></div>",
			"<_script>",
            "[[node]]",
			"var wikiFields = ",
			"[ ",
			"    [",
			"        'photographer',",
			"        'title',",
			"        'desription',",
			"        'depicted people',",
			"        'depicted_place',",
			"        'date',",
			"        'medium',",
			"        'dimensions',",
			"        'institution',",
			"        'department',",
			"        'references',",
			"        'object history',",
			"        'exhibition history',",
			"        'credit line',",
			"        'inscriptions',",
			"        'notes',",
			"        'accession number',",
			"        'source',",
			"        'permission',",
			"        'other versions'",
			"    ],",
			"    [",
			"        'title',",
			"        'description',",
			"        'legend',",
			"        'author',",
			"        'imgen',",
			"        'date',",
			"        'source',",
			"        'permission',",
			"        'mapdate',",
			"        'location',",
			"        'projection',",
			"        'scale',",
			"        'heading',",
			"        'latitude',",
			"        'longitude',",
			"        'warped',",
			"        'set',",
			"        'sheet',",
			"        'type',",
			"        'language',",
			"        'publisher',",
			"        'printer',",
			"        'printdate',",
			"        'institution',",
			"        'accessionnumber',",
			"        'dimensions',",
			"        'medium',",
			"        'inscriptions',",
			"        'notes',",
			"        'other versions'",
			"    ]",
			"]; ",
			
			"var sel = node.params.template;",
			"for(var i = 0; i < wikiFields[sel].length; i++) { ",
            "   var label = '<label>' + wikiFields[sel][i] + '</label>'; ", 
            "   var input1 = '<input name=\"_wt_1_' + wikiFields[sel][i] + '\" class=\"short_input\" /><span > + </span>'; ",
            "   var input2 = '<input name=\"_wt_2_' + wikiFields[sel][i] + '\" class=\"dynamic_field middle_input\" /> <span > + </span>'; ",
            "   var input3 = '<input name=\"_wt_3_' + wikiFields[sel][i] + '\" class=\"short_input\" /><span > + </span>'; ",
            "   var input4 = '<input name=\"_wt_4_' + wikiFields[sel][i] + '\" class=\"dynamic_field middle_input\" /><span > + </span>'; ",
            "   var input5 = '<input name=\"_wt_5_' + wikiFields[sel][i] + '\" class=\"short_input\" /><span > + </span>'; ",
            "   var input6 = '<input name=\"_wt_6_' + wikiFields[sel][i] + '\" class=\"dynamic_field middle_input\" /><span > + </span>'; ",
            "   var input7 = '<input name=\"_wt_7_' + wikiFields[sel][i] + '\" class=\"short_input\" />'; ",
			"    if(node.settings) {",
			"        $('.template_map').append( label +'<input name=\"_wt_' + wikiFields[sel][i]+'\" class=\"dynamic_field\" value=\"'+node.settings['_wt_'+wikiFields[sel][i]]+'\"/>'); ",
			"    } else {",
			"        $('#node_set___node_id__').append( label + input1 + input2 + input3 + input4 + input5 + input6 + input7); ",
            "    }",
			"}",
			"</_script>",
			"<br><label>Categories</label>",
			"<input class='dynamic_field' name='categories'/>",
			"<br><label>Category for all</label>",
			"<input name='category_all'/>"
		]
	}
}
